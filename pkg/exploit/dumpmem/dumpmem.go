package dumpmem

import (
	"fmt"

	"github.com/google/gousb"

	"github.com/freemyipod/wInd3x/pkg/dfu"
	"github.com/freemyipod/wInd3x/pkg/exploit"
	"github.com/freemyipod/wInd3x/pkg/uasm"
)

func Trigger(usb *gousb.Device, ep *exploit.Parameters, addr uint32) ([]byte, error) {
	if err := dfu.Clean(usb); err != nil {
		return nil, fmt.Errorf("clean failed: %w", err)
	}
	insns := ep.DisableICache
	insns = append(insns, ep.HandlerFooter(addr)...)
	payload := uasm.Program{
		Address: ep.ExecAddr,
		Listing: insns,
	}

	return exploit.RCE(usb, ep, payload.Assemble(), nil)
}
